#library(devtools)
#install_git("https://github.com/wietsefranssen/mtclimR.git", branch="newSetup")

rm (list = ls())
library(WFRTools)
start.time1 <- Sys.time()
library(doParallel)
library(mtclimR)
# library(pbdNCDF4)
registerDoParallel(cores=2)

## INIT SETTINGS
settings <- initSettings(startdate = "1950-01-01",
                         enddate = "1950-12-31",
                         outstep = 6,
                         lonlatbox = c(100.75, 102.25, 32.25, 36.25))
                         #lonlatbox = c(92.25, 110.25, 7.25, 36.25))
#lonlatbox = c(-179.75, 179.75, 7.25, 36.25))
#lonlatbox = c(92.25, 110.25, 7.25, 36.25))
setSubDomains <- function(settings, mask, partSize = NULL) {
  mask <- elevation
  # partSize <- 50
  # partSize <- 59
  # partBased <- "lon"
  # partSize <-NULL
  nCells<-length(mask$xyCoords$x)*length(mask$xyCoords$y)

  if (is.null(partSize)) {
    print(paste0("Partsize not defined, so using max: ", nCells, " (only 1 part)"))
    partSize <- nCells
  }
  partSizeOld <- partSize
  partSize <- ceiling(partSize/length(mask$xyCoords$y)) * length(mask$xyCoords$y)
  if (partSizeOld != partSize) {
    print(paste0("partsize should be a multiplication of ny(", length(mask$xyCoords$y),"), so changed to: ", partSize))
  }

  nActive <- length(mask$Data[!is.na(mask$Data)])
  nPart<-ceiling(nCells/partSize)
  print(paste0("Total cells: ", nCells, ", Active Cells: ", nActive, ", nParts: ", nPart))

  part <- list(sx = NULL,
               nx = partSize/length(mask$xyCoords$y),
               sy = 1,
               ny = length(mask$xyCoords$y),
               slon = NULL,
               elon = NULL,
               slat = min(mask$xyCoords$y),
               elat = max(mask$xyCoords$y))
  parts <- list(part)[rep(1,nPart)]

  for (iPart in 1:(nPart)) {
    parts[[iPart]]$sx <- (iPart -1) * (partSize/length(mask$xyCoords$y)) +1
    parts[[iPart]]$slon <- mask$xyCoords$x[parts[[iPart]]$sx]
    parts[[iPart]]$elon <- mask$xyCoords$x[iPart * (partSize/length(mask$xyCoords$y))]
  }
  parts[[nPart]]$elon <- mask$xyCoords$x[length(mask$xyCoords$x)]
  parts[[nPart]]$nx <- (length(mask$xyCoords$x) - parts[[nPart]]$sx) + 1

  return(parts)
}
# setSubDomains <- function(settings, mask, partSize = NULL) {
#   mask <- elevation
#   partSize <- 50
#   # partSize <- 59
#   # partBased <- "lon"
#   # partSize <-NULL
#   nCells<-length(mask$xyCoords$x)*length(mask$xyCoords$y)
#
#   if (is.null(partSize)) {
#     print(paste0("Partsize not defined, so using max: ", nCells, " (only 1 part)"))
#     partSize <- nCells
#   }
#   partSizeOld <- partSize
#   nPart<-ceiling(nCells/partSize)
#   partSize<-ceiling(sqrt(nCells/nPart))^2
#   nPart<-ceiling(nCells/partSize)
#   # partSize <- ceiling(nCells/partSize)
#   if (partSizeOld != partSize) {
#     print(paste0("partsize should be a multiplication of ny(", length(mask$xyCoords$y),"), so changed to: ", partSize))
#   }
#
#   nActive <- length(mask$Data[!is.na(mask$Data)])
#   print(paste0("Total cells: ", nCells, ", Active Cells: ", nActive, ", nParts: ", nPart))
#
#   part <- list(sx = NULL,
#                nx = partSize/length(mask$xyCoords$y),
#                sy = 1,
#                ny = length(mask$xyCoords$y),
#                slon = NULL,
#                elon = NULL,
#                slat = min(mask$xyCoords$y),
#                elat = max(mask$xyCoords$y))
#   parts <- list(part)[rep(1,nPart)]
#
#   for (iPart in 1:(nPart)) {
#     parts[[iPart]]$sx <- (iPart -1) * (partSize/length(mask$xyCoords$y)) +1
#     parts[[iPart]]$slon <- mask$xyCoords$x[parts[[iPart]]$sx]
#     parts[[iPart]]$elon <- mask$xyCoords$x[iPart * (partSize/length(mask$xyCoords$y))]
#   }
#   parts[[nPart]]$elon <- mask$xyCoords$x[length(mask$xyCoords$x)]
#   parts[[nPart]]$nx <- (length(mask$xyCoords$x) - parts[[nPart]]$sx) + 1
#
#   return(parts)
# }


## INIT INPUT FILES/VARS
settings <- setInputVars(settings,list(
  pr         = list(ncFileName = "/home/wietse/Documents/Projects/VIC_model/MetSim/dataWietse/pr_bced_1960_1999_gfdl-esm2m_hist_1950.nc",        ncName = "prAdjust",        alma = TRUE, vicIndex = 9),
  tasmin     = list(ncFileName = "/home/wietse/Documents/Projects/VIC_model/MetSim/dataWietse/tasmin_bced_1960_1999_gfdl-esm2m_hist_1950.nc",        ncName = "tasminAdjust",     vicIndex = 17),
  tasmax     = list(ncFileName = "/home/wietse/Documents/Projects/VIC_model/MetSim/dataWietse/tasmax_bced_1960_1999_gfdl-esm2m_hist_1950.nc",        ncName = "tasmaxAdjust",     vicIndex = 16),
  wind       = list(ncFileName = "/home/wietse/Documents/Projects/VIC_model/MetSim/dataWietse/wind_bced_1960_1999_gfdl-esm2m_hist_1950.nc",        ncName = "windAdjust",       vicIndex = 20)
  # shortwave  = list(ncFileName = "/home/wietse/Documents/Projects/VIC_model/MetSim/dataWietse",        ncName = "tasmaxAdjust", vicIndex = 14),
  # longwave   = list(ncFileName = "/home/wietse/Documents/Projects/VIC_model/MetSim/dataWietse",        ncName = "tasmaxAdjust",  vicIndex = 6)
))
settings$elevation  <- list(ncFileName = "/home/wietse/Documents/Projects/VIC_model/MetSim/dataWietse/WFDEI-elevation.nc", ncName = "elevation")

## INIT INPUT FILES/VARS
settings <- setInputVars(settings,list(
                           pr         = list(ncFileName = "./data/merged_Mekong.nc",        ncName = "prAdjust",        vicIndex = 9,   alma = FALSE),
                           tasmin     = list(ncFileName = "./data/merged_Mekong.nc",        ncName = "tasminAdjust",    vicIndex = 17),
                           tasmax     = list(ncFileName = "./data/merged_Mekong.nc",        ncName = "tasmaxAdjust",    vicIndex = 16),
                           wind       = list(ncFileName = "./data/merged_Mekong.nc",        ncName = "windAdjust",      vicIndex = 20)
                         ))
settings$elevation <- list(ncFileName = "./data/domain_elev_Mekong.nc", ncName = "elev")

## INIT OUTPUT FILES/VARS
settings$outputVars <- list(
  pr         = list(ncName = "pr"),
  tas     = list(ncName = "tas"),
  shortwave     = list(ncName = "shortwave"),
  longwave     = list(ncName = "longwave"),
  pressure     = list(ncName = "pressure"),
  wind       = list(ncName = "wind")
)

### THE MAIN ROUTINE
#############
## LOAD MASK/ELEVATION
elevation <- ncLoad(file = settings$elevation$ncFileName,
                    varName = settings$elevation$ncName,
                    lonlatbox = settings$lonlatbox)

## makeOutputNetCDF
makeNetcdfOut(settings, elevation)

## DIVIDE DOMAIN IN PARTS (NOT TO SMALL AND NOT TOO BIG(SPEED vs MEMORY))
settings$parts<- setSubDomains(settings, elevation, partSize = NULL)
# settings$parts<- setSubDomains(settings, elevation, partSize = 200)
for (iPart in 1:length(settings$parts)) {
  print(paste("part:", iPart, settings$parts[[iPart]]$sx, settings$parts[[iPart]]$nx, settings$parts[[iPart]]$sy, settings$parts[[iPart]]$ny,
              settings$parts[[iPart]]$slon, settings$parts[[iPart]]$elon, settings$parts[[iPart]]$slat, settings$parts[[iPart]]$elat))
}


## SUBDOMAIN LOOP / MPI LOOP
foreach(iPart = 1:length(settings$parts)) %dopar% {
  # for (iPart in 1:length(settings$parts)) {

  start.time.data <- Sys.time()
  print(paste0("doing part: ", iPart, "/", length(settings$parts)))

  ## DEFINE OUTPUT ARRAY
  el <- array(NA, dim = c(settings$parts[[iPart]]$nx, settings$parts[[iPart]]$ny,settings$intern$nrec_out))
  toNetCDFData <- list(el)[rep(1,length(settings$outputVars))]

  ## LOAD SUBDOMAIN FROM NETCDF
  #######
  forcing_dataRTotal <- readForcing(settings, iPart)
  #######
  end.time.data <- Sys.time()
  time.taken <- end.time.data - start.time.data
  print(paste("data:   ", iPart, ",  ", time.taken))

  start.time.mtclim <- Sys.time()
  ## CELL LOOP
  for (iy in 1:settings$parts[[iPart]]$ny) {
    # print(paste0("iy: ", iy, "/", settings$parts[[iPart]]$ny))
    for (ix in 1:settings$parts[[iPart]]$nx) {
      # print(paste(iy,ix))
      iix <-settings$parts[[iPart]]$sx+ix-1
      iiy <-settings$parts[[iPart]]$sy+iy-1
      if (!is.na(elevation$Data[iiy,iix])) {
        forcing_dataR <- selectForcingCell(settings, forcing_dataRTotal, ix, iy)

        settings$mtclim$elevation <- elevation$Data[iiy,iix]
        settings$mtclim$lon<-elevation$xyCoords$x[iix]
        settings$mtclim$lat<-elevation$xyCoords$y[iiy]

        ## RUN MLTCLIM
        output <- mtclimRun(forcing_dataR = forcing_dataR, settings = settings$mtclim)

        ## ADD TO OUTPUT ARRAY
        for (iVar in 1:length(settings$outputVars)) toNetCDFData[[iVar]][ix,iy,] <- output$out_data[[iVar]]
      }
    }
  }
  end.time.mtclim <- Sys.time()
  time.taken <- end.time.mtclim - start.time.mtclim
  print(paste("mtclim: ", iPart, ",  ", time.taken)); rm(start.time.mtclim, end.time.mtclim, time.taken)

  ## ADD OUTPUT TO NETCDF
  ncid <- nc_open(settings$outfile, write = TRUE)
  for (iVar in 1:length(settings$outputVars))
  {
    ncvar_put(ncid,
              settings$outputVars[[iVar]]$ncName,
              toNetCDFData[[iVar]],
              start = c(settings$parts[[iPart]]$sx,
                        settings$parts[[iPart]]$sy,
                        1),
              count = c(settings$parts[[iPart]]$nx,
                        settings$parts[[iPart]]$ny,
                        settings$intern$nrec_out)
    )
  }
  nc_close(ncid)

}
################
end.time <- Sys.time()
time.taken <- end.time - start.time1
print(time.taken); rm(start.time1, end.time, time.taken)

